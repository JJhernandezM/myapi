name: Docker Image CI

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Log in to DockerHub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build Docker Image
        run: |
          # Construir la imagen Docker con el tag 'latest'
          docker build -t jonso18/my-api:latest .
      
      - name: Push Docker Image
        run: |
          # Publicar la imagen Docker a DockerHub con el tag 'latest'
          docker push jonso18/my-api:latest

      - name: Update Kubernetes Deployment YAML
        run: |
          # Actualizar el archivo deployment.yaml con el tag 'latest'
          sed -i 's|image: jonso18/my-api:.*|image: jonso18/my-api:latest|' k8s/deployment.yaml

      - name: Commit and push updated deployment YAML
        run: |
          # Configurar el usuario de git para hacer el commit
          git config --global user.name "John Hernandez"
          git config --global user.email "jonso18@gmail.com"
          # Forzar el commit de los cambios, incluso si no hay diferencias
          git add k8s/deployment.yaml
          git commit -m "Force update image tag to latest"
          
          git push
